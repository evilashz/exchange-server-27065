using System;
using System.IO;
using System.Threading;
using Microsoft.Exchange.Diagnostics.Components.MalwareAgent;

namespace Microsoft.Exchange.Transport.Agent.Malware.SoftDelete
{
	// Token: 0x0200000F RID: 15
	internal class CalculationAsync
	{
		// Token: 0x0600003B RID: 59 RVA: 0x00003E1B File Offset: 0x0000201B
		public CalculationAsync(SoftDeleteQueue softDeleteQueue)
		{
			if (softDeleteQueue == null)
			{
				throw new ArgumentNullException("SoftDeleteQueue cannot be null with making a new instance of the calculationAsync.");
			}
			this.softDeleteQueue = softDeleteQueue;
		}

		// Token: 0x17000007 RID: 7
		// (get) Token: 0x0600003C RID: 60 RVA: 0x00003E38 File Offset: 0x00002038
		public SoftDeleteQueue SoftDeleteQueue
		{
			get
			{
				return this.softDeleteQueue;
			}
		}

		// Token: 0x0600003D RID: 61 RVA: 0x00003E40 File Offset: 0x00002040
		public long GetDestinationSize(string directory)
		{
			if (string.IsNullOrEmpty(directory))
			{
				throw new ArgumentException("Directory cannot be created when null or empty.");
			}
			long num = 0L;
			if (!Directory.Exists(directory))
			{
				throw new ArgumentException("Directory does not exists.");
			}
			string[] files = Directory.GetFiles(directory.ToString(), "*.*");
			foreach (string fileName in files)
			{
				try
				{
					FileInfo fileInfo = new FileInfo(fileName);
					num += fileInfo.Length;
				}
				catch (OverflowException ex)
				{
					num = long.MaxValue;
					ExTraceGlobals.AgentTracer.TraceDebug<string>((long)this.GetHashCode(), "The number of bytes has exceeded the value that can be stored in a type long. Error = {0}", ex.ToString());
					break;
				}
			}
			return num;
		}

		// Token: 0x0600003E RID: 62 RVA: 0x00003EF4 File Offset: 0x000020F4
		public IAsyncResult BeginCalculation(AsyncCallback callback, object state)
		{
			CalcAsyncResult<long> calcAsyncResult = new CalcAsyncResult<long>(callback, state);
			ThreadPool.QueueUserWorkItem(new WaitCallback(this.GetDestinationSizeHelper), calcAsyncResult);
			return calcAsyncResult;
		}

		// Token: 0x0600003F RID: 63 RVA: 0x00003F20 File Offset: 0x00002120
		public long EndCalculation(IAsyncResult calcAsyncResult)
		{
			if (calcAsyncResult == null)
			{
				throw new ArgumentException("EndCalculation called with calcAsyncResult as null");
			}
			CalcAsyncResult<long> calcAsyncResult2 = calcAsyncResult as CalcAsyncResult<long>;
			return calcAsyncResult2.EndInvoke();
		}

		// Token: 0x06000040 RID: 64 RVA: 0x00003F48 File Offset: 0x00002148
		private void GetDestinationSizeHelper(object calcAsyncResult)
		{
			if (calcAsyncResult == null)
			{
				throw new ArgumentException("GetDestinationSizeHelper cannot be called with calcAsyncResult set to null.");
			}
			CalcAsyncResult<long> calcAsyncResult2 = calcAsyncResult as CalcAsyncResult<long>;
			try
			{
				long destinationSize = this.GetDestinationSize(this.SoftDeleteQueue.Storage.GetStorageDestination());
				calcAsyncResult2.SetAsCompleted(destinationSize, false);
			}
			catch (Exception exception)
			{
				calcAsyncResult2.SetAsCompleted(exception, false);
			}
		}

		// Token: 0x04000014 RID: 20
		private SoftDeleteQueue softDeleteQueue;
	}
}
