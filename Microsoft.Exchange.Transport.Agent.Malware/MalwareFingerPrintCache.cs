using System;
using System.Configuration;
using System.Reflection;
using System.Threading;
using Microsoft.Exchange.Collections.TimeoutCache;

namespace Microsoft.Exchange.Transport.Agent.Malware
{
	// Token: 0x0200003A RID: 58
	internal class MalwareFingerPrintCache
	{
		// Token: 0x0600015D RID: 349 RVA: 0x00009FA0 File Offset: 0x000081A0
		private MalwareFingerPrintCache()
		{
			AppDomain currentDomain = AppDomain.CurrentDomain;
			ResolveEventHandler value = new ResolveEventHandler(MalwareFingerPrintCache.CurrentDomainAssemblyResolve);
			try
			{
				currentDomain.AssemblyResolve += value;
				this.config = MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration.GetInstance();
				this.cache = new TimeoutCache<MalwareFingerPrint, MalwareFingerPrintDetails>(this.config.NumberOfCacheBuckets, this.config.MaxCacheBucketSize, false);
			}
			finally
			{
				currentDomain.AssemblyResolve -= value;
			}
		}

		// Token: 0x17000054 RID: 84
		// (get) Token: 0x0600015E RID: 350 RVA: 0x0000A014 File Offset: 0x00008214
		public long Count
		{
			get
			{
				return (long)this.cache.Count;
			}
		}

		// Token: 0x0600015F RID: 351 RVA: 0x0000A024 File Offset: 0x00008224
		public static MalwareFingerPrintCache GetInstance()
		{
			if (MalwareFingerPrintCache.singleton == null)
			{
				lock (MalwareFingerPrintCache.singletonLock)
				{
					if (MalwareFingerPrintCache.singleton == null)
					{
						MalwareFingerPrintCache malwareFingerPrintCache = new MalwareFingerPrintCache();
						Thread.MemoryBarrier();
						MalwareFingerPrintCache.singleton = malwareFingerPrintCache;
					}
				}
			}
			return MalwareFingerPrintCache.singleton;
		}

		// Token: 0x06000160 RID: 352 RVA: 0x0000A084 File Offset: 0x00008284
		public void Add(MalwareFingerPrint fingerPrint, MalwareFingerPrintDetails fingerPrintDetails)
		{
			if (fingerPrint == null)
			{
				return;
			}
			try
			{
				this.cache.AddSliding(fingerPrint, fingerPrintDetails, this.config.SlidingCacheTimeout, null);
			}
			catch (DuplicateKeyException)
			{
			}
		}

		// Token: 0x06000161 RID: 353 RVA: 0x0000A0C4 File Offset: 0x000082C4
		public MalwareFingerPrintDetails Get(MalwareFingerPrint fingerPrint)
		{
			if (fingerPrint == null)
			{
				return null;
			}
			MalwareFingerPrintDetails result = null;
			this.cache.TryGetValue(fingerPrint, out result);
			return result;
		}

		// Token: 0x06000162 RID: 354 RVA: 0x0000A0E8 File Offset: 0x000082E8
		private static Assembly CurrentDomainAssemblyResolve(object sender, ResolveEventArgs args)
		{
			Assembly executingAssembly = Assembly.GetExecutingAssembly();
			if (!(args.Name == executingAssembly.GetName().Name))
			{
				return null;
			}
			return executingAssembly;
		}

		// Token: 0x0400014E RID: 334
		private const string Name = "MalwareFingerPrinting";

		// Token: 0x0400014F RID: 335
		private static MalwareFingerPrintCache singleton;

		// Token: 0x04000150 RID: 336
		private static object singletonLock = new object();

		// Token: 0x04000151 RID: 337
		private TimeoutCache<MalwareFingerPrint, MalwareFingerPrintDetails> cache;

		// Token: 0x04000152 RID: 338
		private MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration config;

		// Token: 0x0200003B RID: 59
		private class MalwareFingerPrintCacheConfiguration : ConfigurationSection
		{
			// Token: 0x17000055 RID: 85
			// (get) Token: 0x06000164 RID: 356 RVA: 0x0000A122 File Offset: 0x00008322
			// (set) Token: 0x06000165 RID: 357 RVA: 0x0000A134 File Offset: 0x00008334
			[IntegerValidator(ExcludeRange = false, MinValue = 1, MaxValue = 20)]
			[ConfigurationProperty("numberOfCacheBuckets", IsRequired = false, DefaultValue = 1)]
			public int NumberOfCacheBuckets
			{
				get
				{
					return (int)base["numberOfCacheBuckets"];
				}
				internal set
				{
					base["numberOfCacheBuckets"] = value;
				}
			}

			// Token: 0x17000056 RID: 86
			// (get) Token: 0x06000166 RID: 358 RVA: 0x0000A147 File Offset: 0x00008347
			// (set) Token: 0x06000167 RID: 359 RVA: 0x0000A159 File Offset: 0x00008359
			[ConfigurationProperty("maxCacheBucketSize", IsRequired = false, DefaultValue = 1000)]
			[IntegerValidator(ExcludeRange = false, MinValue = 100)]
			public int MaxCacheBucketSize
			{
				get
				{
					return (int)base["maxCacheBucketSize"];
				}
				internal set
				{
					base["maxCacheBucketSize"] = value;
				}
			}

			// Token: 0x17000057 RID: 87
			// (get) Token: 0x06000168 RID: 360 RVA: 0x0000A16C File Offset: 0x0000836C
			// (set) Token: 0x06000169 RID: 361 RVA: 0x0000A17E File Offset: 0x0000837E
			[ConfigurationProperty("slidingCacheTimeout", IsRequired = false, DefaultValue = "00:15:00")]
			public TimeSpan SlidingCacheTimeout
			{
				get
				{
					return (TimeSpan)base["slidingCacheTimeout"];
				}
				internal set
				{
					base["slidingCacheTimeout"] = value;
				}
			}

			// Token: 0x0600016A RID: 362 RVA: 0x0000A194 File Offset: 0x00008394
			public static MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration GetInstance()
			{
				if (MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration.instance == null)
				{
					MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration.instance = (MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration)ConfigurationManager.GetSection("MalwareFingerPrintCache");
					if (MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration.instance == null)
					{
						string exeConfigFilename = Uri.UnescapeDataString(new UriBuilder(Assembly.GetExecutingAssembly().CodeBase).Path) + ".config";
						ExeConfigurationFileMap fileMap = new ExeConfigurationFileMap
						{
							ExeConfigFilename = exeConfigFilename
						};
						Configuration configuration = ConfigurationManager.OpenMappedExeConfiguration(fileMap, ConfigurationUserLevel.None);
						MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration.instance = (MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration)configuration.GetSection("MalwareFingerPrintCache");
					}
					if (MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration.instance == null)
					{
						MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration.instance = new MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration();
					}
				}
				return MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration.instance;
			}

			// Token: 0x04000153 RID: 339
			private const string NumberOfCacheBucketsKey = "numberOfCacheBuckets";

			// Token: 0x04000154 RID: 340
			private const string MaxCacheBucketSizeKey = "maxCacheBucketSize";

			// Token: 0x04000155 RID: 341
			private const string SlidingCacheTimeoutKey = "slidingCacheTimeout";

			// Token: 0x04000156 RID: 342
			private const string SectionName = "MalwareFingerPrintCache";

			// Token: 0x04000157 RID: 343
			private static MalwareFingerPrintCache.MalwareFingerPrintCacheConfiguration instance;
		}
	}
}
