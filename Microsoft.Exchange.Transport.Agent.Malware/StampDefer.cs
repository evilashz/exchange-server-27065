using System;
using System.Text;
using Microsoft.Exchange.Transport.Agent.Malware.Actions;

namespace Microsoft.Exchange.Transport.Agent.Malware
{
	// Token: 0x0200002F RID: 47
	internal class StampDefer : IEquatable<StampDefer>
	{
		// Token: 0x0600010C RID: 268 RVA: 0x00009408 File Offset: 0x00007608
		public StampDefer(int deferredCount, int maxDeferredCount, double originalDeferWaitTimeMinutes, TimeSpan waitTime, Type finalAction, bool isCrashRecoverable, bool isTimeoutRecoverable)
		{
			if (maxDeferredCount != -1 && maxDeferredCount <= 0)
			{
				throw new ArgumentOutOfRangeException("The maximum deferred count has to be greater than 0.", "maxDeferredCount");
			}
			if (deferredCount <= 0)
			{
				throw new ArgumentOutOfRangeException("The deferred count has to be greater than 0.", "deferredCount");
			}
			if (!finalAction.IsSubclassOf(typeof(Microsoft.Exchange.Transport.Agent.Malware.Actions.Action)))
			{
				throw new ArgumentException("The final action type must be derived from Action", "finalAction");
			}
			this.DeferredCount = deferredCount;
			this.MaxDeferredCount = maxDeferredCount;
			this.WaitTime = waitTime;
			this.OriginalDeferWaitTime = TimeSpan.FromMinutes(originalDeferWaitTimeMinutes);
			this.FinalActionType = finalAction;
			this.IsCrashRecoverable = isCrashRecoverable;
			this.IsTimeoutRecoverable = isTimeoutRecoverable;
		}

		// Token: 0x17000039 RID: 57
		// (get) Token: 0x0600010D RID: 269 RVA: 0x000094A4 File Offset: 0x000076A4
		// (set) Token: 0x0600010E RID: 270 RVA: 0x000094AC File Offset: 0x000076AC
		public int DeferredCount { get; private set; }

		// Token: 0x1700003A RID: 58
		// (get) Token: 0x0600010F RID: 271 RVA: 0x000094B5 File Offset: 0x000076B5
		// (set) Token: 0x06000110 RID: 272 RVA: 0x000094BD File Offset: 0x000076BD
		public int MaxDeferredCount { get; set; }

		// Token: 0x1700003B RID: 59
		// (get) Token: 0x06000111 RID: 273 RVA: 0x000094C6 File Offset: 0x000076C6
		// (set) Token: 0x06000112 RID: 274 RVA: 0x000094CE File Offset: 0x000076CE
		public TimeSpan WaitTime { get; private set; }

		// Token: 0x1700003C RID: 60
		// (get) Token: 0x06000113 RID: 275 RVA: 0x000094D7 File Offset: 0x000076D7
		// (set) Token: 0x06000114 RID: 276 RVA: 0x000094DF File Offset: 0x000076DF
		public TimeSpan OriginalDeferWaitTime { get; private set; }

		// Token: 0x1700003D RID: 61
		// (get) Token: 0x06000115 RID: 277 RVA: 0x000094E8 File Offset: 0x000076E8
		// (set) Token: 0x06000116 RID: 278 RVA: 0x000094F0 File Offset: 0x000076F0
		public Type FinalActionType { get; private set; }

		// Token: 0x1700003E RID: 62
		// (get) Token: 0x06000117 RID: 279 RVA: 0x000094F9 File Offset: 0x000076F9
		// (set) Token: 0x06000118 RID: 280 RVA: 0x00009501 File Offset: 0x00007701
		public bool IsCrashRecoverable { get; private set; }

		// Token: 0x1700003F RID: 63
		// (get) Token: 0x06000119 RID: 281 RVA: 0x0000950A File Offset: 0x0000770A
		// (set) Token: 0x0600011A RID: 282 RVA: 0x00009512 File Offset: 0x00007712
		public bool IsTimeoutRecoverable { get; private set; }

		// Token: 0x0600011B RID: 283 RVA: 0x0000951C File Offset: 0x0000771C
		public static bool TryParse(string text, double originalDeferWaitTimeMinutes, out StampDefer stamp)
		{
			stamp = null;
			if (string.IsNullOrEmpty(text))
			{
				return false;
			}
			string[] array = text.Split(new char[]
			{
				';'
			});
			if (array.Length < 4)
			{
				return false;
			}
			int num = 0;
			if (!int.TryParse(array[0], out num))
			{
				return false;
			}
			int num2 = 0;
			if (!int.TryParse(array[1], out num2))
			{
				return false;
			}
			TimeSpan waitTime = new TimeSpan(0L);
			if (!TimeSpan.TryParse(array[2], out waitTime))
			{
				return false;
			}
			Type typeFromHandle = typeof(ActionDefer);
			if (!StampDefer.TryParseActionType(array[3], out typeFromHandle))
			{
				return false;
			}
			bool isCrashRecoverable = false;
			if (array.Length >= 5 && !bool.TryParse(array[4], out isCrashRecoverable))
			{
				return false;
			}
			bool isTimeoutRecoverable = false;
			if (array.Length >= 6 && !bool.TryParse(array[5], out isTimeoutRecoverable))
			{
				return false;
			}
			if (num2 != -1 && num2 <= 0)
			{
				return false;
			}
			if (num <= 0)
			{
				return false;
			}
			stamp = new StampDefer(num, num2, originalDeferWaitTimeMinutes, waitTime, typeFromHandle, isCrashRecoverable, isTimeoutRecoverable);
			return true;
		}

		// Token: 0x0600011C RID: 284 RVA: 0x000095FC File Offset: 0x000077FC
		public static TimeSpan GetRandomizedWaitTime(double waitTimeMinutes)
		{
			double val = waitTimeMinutes * 60.0 + StampDefer.random.NextDouble() * 180.0;
			return TimeSpan.FromSeconds(Math.Min(val, Constants.SecondsPerDay));
		}

		// Token: 0x0600011D RID: 285 RVA: 0x0000963C File Offset: 0x0000783C
		public override string ToString()
		{
			StringBuilder stringBuilder = new StringBuilder();
			stringBuilder.Append(this.DeferredCount);
			stringBuilder.Append(';');
			stringBuilder.Append(this.MaxDeferredCount);
			stringBuilder.Append(';');
			stringBuilder.Append(this.WaitTime);
			stringBuilder.Append(';');
			stringBuilder.Append(StampDefer.ConvertTypeToString(this.FinalActionType));
			if (this.IsCrashRecoverable || this.IsTimeoutRecoverable)
			{
				stringBuilder.Append(';');
				stringBuilder.Append(this.IsCrashRecoverable);
				stringBuilder.Append(';');
				stringBuilder.Append(this.IsTimeoutRecoverable);
			}
			return stringBuilder.ToString();
		}

		// Token: 0x0600011E RID: 286 RVA: 0x000096EC File Offset: 0x000078EC
		public void NextDefer(int maxDeferAttempts, bool isCrashRecoverable, bool isTimeoutRecoverable)
		{
			this.IsCrashRecoverable = isCrashRecoverable;
			this.IsTimeoutRecoverable = isTimeoutRecoverable;
			if (maxDeferAttempts > 2147483646 || maxDeferAttempts < 0)
			{
				throw new ArgumentOutOfRangeException("The maximum defer attempts is outside of the acceptable range.");
			}
			int num = this.DeferredCount + 1;
			if (num > 2147483646 || num < 0)
			{
				throw new ArgumentOutOfRangeException("The defer count is outside of the acceptable range.");
			}
			if (num <= maxDeferAttempts)
			{
				this.DeferredCount++;
				this.WaitTime = StampDefer.GetRandomizedWaitTime((double)this.DeferredCount * this.OriginalDeferWaitTime.TotalMinutes);
				return;
			}
			if (this.MaxDeferredCount == -1)
			{
				this.DeferredCount++;
				int num2 = this.DeferredCount - maxDeferAttempts;
				if (num2 <= 0)
				{
					num2 = 1;
				}
				this.WaitTime = StampDefer.GetRandomizedWaitTime((double)num2 * Constants.MinutesinHour);
				return;
			}
			throw new ArgumentOutOfRangeException("Unable to be deferred any more.");
		}

		// Token: 0x0600011F RID: 287 RVA: 0x000097B8 File Offset: 0x000079B8
		public bool Equals(StampDefer rhs)
		{
			return this.DeferredCount == rhs.DeferredCount && this.MaxDeferredCount == rhs.MaxDeferredCount && this.OriginalDeferWaitTime == rhs.OriginalDeferWaitTime && this.WaitTime == rhs.WaitTime && this.FinalActionType == rhs.FinalActionType && this.IsCrashRecoverable == rhs.IsCrashRecoverable && this.IsTimeoutRecoverable == rhs.IsTimeoutRecoverable;
		}

		// Token: 0x06000120 RID: 288 RVA: 0x0000983C File Offset: 0x00007A3C
		private static string ConvertTypeToString(Type type)
		{
			string name = type.Name;
			if (!name.Equals("ActionDefer") && !name.Equals("ActionAllow") && !name.Equals("ActionDelete") && !name.Equals("ActionReplace") && !name.Equals("ActionDeferForever") && !name.Equals("ActionSoftDelete") && !name.Equals("ActionReject"))
			{
				throw new ArgumentException("The type is not one of the allowed types.");
			}
			return name;
		}

		// Token: 0x06000121 RID: 289 RVA: 0x000098B8 File Offset: 0x00007AB8
		private static bool TryParseActionType(string typeText, out Type type)
		{
			type = null;
			if (string.IsNullOrEmpty(typeText))
			{
				return false;
			}
			if (typeText.Equals("ActionDefer"))
			{
				type = typeof(ActionDefer);
				return true;
			}
			if (typeText.Equals("ActionAllow"))
			{
				type = typeof(ActionAllow);
				return true;
			}
			if (typeText.Equals("ActionDelete"))
			{
				type = typeof(ActionDelete);
				return true;
			}
			if (typeText.Equals("ActionReplace"))
			{
				type = typeof(ActionReplace);
				return true;
			}
			if (typeText.Equals("ActionDeferForever"))
			{
				type = typeof(ActionDeferForever);
				return true;
			}
			if (typeText.Equals("ActionSoftDelete"))
			{
				type = typeof(ActionSoftDelete);
				return true;
			}
			if (typeText.Equals("ActionReject"))
			{
				type = typeof(ActionReject);
				return true;
			}
			return false;
		}

		// Token: 0x0400012D RID: 301
		public const int DeferForever = -1;

		// Token: 0x0400012E RID: 302
		public const int MaxRandomDeferWindowInSeconds = 180;

		// Token: 0x0400012F RID: 303
		private const char SeparatorCharacter = ';';

		// Token: 0x04000130 RID: 304
		private static readonly Random random = new Random((int)DateTime.UtcNow.Ticks);
	}
}
