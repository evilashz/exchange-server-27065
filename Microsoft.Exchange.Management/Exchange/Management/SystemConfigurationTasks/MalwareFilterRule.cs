using System;
using System.Collections.Generic;
using Microsoft.Exchange.Configuration.Tasks;
using Microsoft.Exchange.Data;
using Microsoft.Exchange.Data.Common;
using Microsoft.Exchange.Data.Directory.SystemConfiguration;
using Microsoft.Exchange.Management.Tasks;
using Microsoft.Exchange.MessagingPolicies.Rules;
using Microsoft.Exchange.MessagingPolicies.Rules.Tasks;

namespace Microsoft.Exchange.Management.SystemConfigurationTasks
{
	// Token: 0x02000A8A RID: 2698
	public class MalwareFilterRule : HygieneFilterRule
	{
		// Token: 0x06005FDD RID: 24541 RVA: 0x0019076B File Offset: 0x0018E96B
		public MalwareFilterRule()
		{
		}

		// Token: 0x06005FDE RID: 24542 RVA: 0x00190774 File Offset: 0x0018E974
		internal MalwareFilterRule(TransportRule transportRule, string name, int priority, RuleState state, string comments, TransportRulePredicate[] conditions, TransportRulePredicate[] exceptions, MalwareFilterPolicyIdParameter policyId) : base(transportRule, name, priority, state, comments, conditions, exceptions, policyId)
		{
			if (base.Conditions != null)
			{
				foreach (TransportRulePredicate predicate in base.Conditions)
				{
					base.SetParametersFromPredicate(predicate, false);
				}
			}
			if (base.Exceptions != null)
			{
				foreach (TransportRulePredicate predicate2 in base.Exceptions)
				{
					base.SetParametersFromPredicate(predicate2, true);
				}
			}
		}

		// Token: 0x17001CF6 RID: 7414
		// (get) Token: 0x06005FDF RID: 24543 RVA: 0x001907EE File Offset: 0x0018E9EE
		internal ObjectSchema Schema
		{
			get
			{
				return MalwareFilterRule.schema;
			}
		}

		// Token: 0x17001CF7 RID: 7415
		// (get) Token: 0x06005FE0 RID: 24544 RVA: 0x001907F5 File Offset: 0x0018E9F5
		// (set) Token: 0x06005FE1 RID: 24545 RVA: 0x00190802 File Offset: 0x0018EA02
		public MalwareFilterPolicyIdParameter MalwareFilterPolicy
		{
			get
			{
				return base.PolicyId as MalwareFilterPolicyIdParameter;
			}
			set
			{
				base.PolicyId = value;
			}
		}

		// Token: 0x06005FE2 RID: 24546 RVA: 0x0019080C File Offset: 0x0018EA0C
		internal override IEnumerable<Microsoft.Exchange.MessagingPolicies.Rules.Action> CreateActions()
		{
			List<Microsoft.Exchange.MessagingPolicies.Rules.Action> list = new List<Microsoft.Exchange.MessagingPolicies.Rules.Action>();
			ShortList<Argument> arguments = new ShortList<Argument>
			{
				new Value("X-MS-Exchange-Organization-MalwareFilterPolicy"),
				new Value(base.PolicyId.ToString())
			};
			list.Add(TransportRuleParser.Instance.CreateAction("SetHeader", arguments, null));
			list.Add(TransportRuleParser.Instance.CreateAction("Halt", new ShortList<Argument>(), null));
			return list;
		}

		// Token: 0x06005FE3 RID: 24547 RVA: 0x00190880 File Offset: 0x0018EA80
		internal override string BuildActionDescription()
		{
			return Strings.MalwareFilterActionDescription((base.PolicyId == null) ? string.Empty : base.PolicyId.ToString());
		}

		// Token: 0x06005FE4 RID: 24548 RVA: 0x001908A6 File Offset: 0x0018EAA6
		internal override void SuppressPiiData(PiiMap piiMap)
		{
			base.SuppressPiiData(piiMap);
			if (base.PolicyId != null)
			{
				base.PolicyId = SuppressingPiiProperty.TryRedactValue<ADIdParameter>(MalwareFilterRuleSchema.MalwareFilterPolicy, base.PolicyId);
			}
		}

		// Token: 0x06005FE5 RID: 24549 RVA: 0x001908D0 File Offset: 0x0018EAD0
		internal static MalwareFilterRule CreateFromInternalRule(TransportRule rule, int priority, TransportRule transportRule)
		{
			IConfigDataProvider session = null;
			if (transportRule != null)
			{
				session = transportRule.Session;
			}
			TransportRulePredicate[] conditions;
			TransportRulePredicate[] exceptions;
			TransportRuleAction[] array;
			Microsoft.Exchange.MessagingPolicies.Rules.Tasks.Rule.TryConvert(HygieneFilterRule.SupportedPredicates, HygieneFilterRule.SupportedActions, rule, out conditions, out exceptions, out array, session);
			if (array == null || array.Length != 2 || !(array[0] is SetHeaderAction) || !(array[1] is StopRuleProcessingAction))
			{
				throw new CorruptFilterRuleException(Strings.CorruptRule(rule.Name, Strings.ErrorCorruptRuleAction));
			}
			string identity = ((SetHeaderAction)array[0]).HeaderValue.ToString();
			return new MalwareFilterRule(transportRule, rule.Name, priority, rule.Enabled, rule.Comments, conditions, exceptions, new MalwareFilterPolicyIdParameter(identity));
		}

		// Token: 0x06005FE6 RID: 24550 RVA: 0x0019097C File Offset: 0x0018EB7C
		internal static MalwareFilterRule CreateCorruptRule(int priority, TransportRule transportRule, LocalizedString errorText)
		{
			return new MalwareFilterRule(transportRule, transportRule.Name, priority, RuleState.Disabled, null, null, null, null)
			{
				isValid = false,
				errorText = errorText
			};
		}

		// Token: 0x04003529 RID: 13609
		private static readonly MalwareFilterRuleSchema schema = ObjectSchema.GetInstance<MalwareFilterRuleSchema>();
	}
}
